---
apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: ip-deny-list
  namespace: {{ .Values.namespace }}
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: eg-infra-shared-01
  authorization:
    defaultAction: Allow
    rules:
    - action: Deny
      principal:
        clientCIDRs:
{{- range $line := .Files.Lines "security/ip_blocklist.txt" }}
{{- $line = trim $line }}
{{- if or (eq $line "") (hasPrefix "//" $line) }}
{{- else if regexMatch "^- " $line }}
{{- $trimmed := trimPrefix "- " $line | trim }}
{{- $ipList := splitList ", " $trimmed }}
{{- range $ip := $ipList }}
        - {{ trim $ip }}/32
{{- end }}
{{- end }}
{{- end }}
